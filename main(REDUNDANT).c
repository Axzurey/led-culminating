#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/io.h>
#include <errno.h>
#include <math.h>

//adapter pins(CTRL): 
/**
 * 
 * normal, reversed, reversed
 * 
*/

/*
x values
(0, 0, 0) -> 3 (p4)
(0, 0, 1) -> 8 (p16)
(0, 1, 0) -> 5 (p6)
(1, 0, 0) -> 1 (p13)
(1, 0, 1) -> 4 (p10)
(1, 1, 0) -> 7 (p15)
(10 nomask) -> 6 (p11) BECOMES (1, 1, 1) -> 6 (p9)
(100000 nomask) -> 2 (p3) BECOMES (011) -> 2 (p1)
*/

/*
y values
(1, 1, 1) -> 1 (p9) BECOMES (10) -> 1 (p11)
(10000 nomask) -> 2 (p14) -> (110010 mask)
(10000000 nomask) -> 3 (p8) -> (10100010 mask)
(100 nomask) -> 4 (p12) -> (100110 mask)
(011) -> 5 (p1) BECOMES (100000) -> 5 (p3)
(1000000 nomask) -> 6 (p7) -> (1100010 mask)
(1000 nomask) -> 7 (p2) -> (101010 mask)
(1 nomask) -> 8 (p5) -> (100011 mask)
*/

void pushX(int x) {

    int coords[8] = {
        0b100,
        0b011,
        0b000,
        0b101,
        0b010,
        0b111,
        0b110,
        0b001
    };
    
    int control = 0x37A;

    if (x < 0 || x > 7) {
        printf("Parameter x is out of bounds %d", x);
        exit(-1);
    }
    outb(coords[x], control);
}

void pushY(int y) {

    int coords[8] = {
        0b10,
        0b10000,
        0b10000000,
        0b100,
        0b100000,
        0b1000000,
        0b1000,
        0b1
    };

    int port = 0x378;

    if (y == -1) {
        outb(0, port);
        return;
    }

    if (y < 0 || y > 7) {
        printf("Parameter y is out of bounds %d", y);
        exit(-1);
    }

    outb(coords[y], port);
}

void decode(int pattern[8][8]) {

    int freq = 40;

    int nOn = 0;

    for (int y = 0; y < 8; y++) {
        for (int x = 0; x < 8; x++) {
            if (pattern[y][x]) {
                nOn ++; 
            }
        }
    }

    for (int y = 0; y < 8; y++) {
        for (int x = 0; x < 8; x++) {
            if (pattern[y][x]) {
                pushX(x);
                pushY(y);
                usleep(1000000 / freq / nOn);
            }
        }
    }
}

void main() {
    int port = 0x378;
    int o = ioperm(port, 3, 1);

    if (o) {
        printf("something went wrong!");
    }

    int patterns[100][8][8] = {};

    int patterns[10][8][8] = {
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0}, 
        },
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 1, 1, 0, 0, 0},
            {0, 0, 0, 1, 1, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
        },
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 1, 1, 1, 1, 0, 0},
            {0, 0, 1, 0, 0, 1, 0, 0},
            {0, 0, 1, 0, 0, 1, 0, 0},
            {0, 0, 1, 1, 1, 1, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
        },
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 1, 1, 1, 1, 1, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 1, 1, 1, 1, 1, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
        },
        {
            {1, 1, 1, 1, 1, 1, 1, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 1, 1, 1, 1, 1, 1, 1},
        },
        {
            {1, 1, 1, 1, 1, 1, 1, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 0, 0, 0, 0, 0, 0, 1},
            {1, 1, 1, 1, 1, 1, 1, 1},
        },
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 1, 1, 1, 1, 1, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 0, 0, 0, 0, 1, 0},
            {0, 1, 1, 1, 1, 1, 1, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
        },
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 1, 1, 1, 1, 0, 0},
            {0, 0, 1, 0, 0, 1, 0, 0},
            {0, 0, 1, 0, 0, 1, 0, 0},
            {0, 0, 1, 1, 1, 1, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
        },
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 1, 1, 0, 0, 0},
            {0, 0, 0, 1, 1, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
        },
        {
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0},
            {0, 0, 0, 0, 0, 0, 0, 0}, 
        },
    };

    while (1) {
        for (int i = 0; i < 10; i++) {
            decode(patterns[i]);
        }
    }
}